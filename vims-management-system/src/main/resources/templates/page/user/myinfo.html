<article class="gi-article-content gi-col-95 gi-row-100">
    <section class="gi-col-100 gi-row-100 gi-overflow-scroll">
        <div class="gi-container-narrow">

            <!-- 페이지 헤더 -->
            <header class="gi-margin-bottom-40px">
                <h1 class="gi-page-title">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.TITLE"]</h1>
                <p class="gi-subtitle-main">개인 정보를 확인하고 수정할 수 있습니다.</p>
            </header>

            <form id="inspectionEquipmentModelTypeModify">

                <!-- [프로필 섹션] -->
                <div class="gi-article-content gi-margin-bottom-30px gi-flex gi-flex-center gi-padding-30px">
                    <div class="user_icon_layout_body">
                        <div class="user_icon_layout">
                            <div class="userIcon"></div>
                        </div>
                        <div class="add_user_img-btn-section">
                            <button id="imgFileUpload" class="add_user_img-btn" type="button"></button>
                        </div>
                    </div>
                </div>

                <!-- [상세 정보 카드] -->
                <div class="gi-article-content">
                    <h2 class="gi-title-section">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_INFO"]</h2>

                    <div class="gi-flex gi-flex-column gi-grid-gap-20px">
                        <input data-field="id" id="id" name="id" class="gi-input gi-hidden" />
                        <input data-field="uuid" id="uuid" name="uuid" class="gi-input gi-hidden" />

                        <div class="gi-flex gi-grid-gap-20px">
                            <div class="gi-input-container" style="flex: 1;">
                                <label for="user_nm" class="gi-input-label" data-focus-label="true"
                                    data-required="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_NAME"]</label>
                                <input data-field="user_nm" id="user_nm" name="user_nm" class="gi-input"
                                    data-required="true" autocomplete="off" />
                            </div>
                            <div class="gi-input-container" style="flex: 1;">
                                <label for="tel" class="gi-input-label"
                                    data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_PHONE_NUMBER"]</label>
                                <input data-field="tel" id="tel" name="tel" class="gi-input" autocomplete="off"
                                    gi-format-check="phone_number" />
                            </div>
                        </div>

                        <div class="gi-flex gi-grid-gap-20px">
                            <div class="gi-input-container" style="flex: 1;">
                                <label for="email" class="gi-input-label" data-focus-label="true"
                                    data-required="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_EMAIL"]</label>
                                <input data-field="email" id="email" name="email" class="gi-input" data-required="true"
                                    autocomplete="off" data-disabled />
                            </div>
                            <div class="gi-input-container" style="flex: 1;">
                                <label for="user_id" class="gi-input-label" data-focus-label="true"
                                    data-required="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_ID"]</label>
                                <input data-field="user_id" id="user_id" name="user_id" class="gi-input"
                                    data-required="true" autocomplete="off" data-disabled />
                            </div>
                        </div>

                        <div class="gi-flex gi-grid-gap-10px">
                            <div class="gi-input-container" style="flex: 4;">
                                <label for="address" class="gi-input-label"
                                    data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_ADDR"]</label>
                                <input data-field="address" id="address" name="address" class="gi-input"
                                    autocomplete="off" data-disabled />
                            </div>
                            <button id="address-btn" class="gi-btn" type="button" gi-address
                                style="flex: 1; height: 40px; margin-top: auto;">주소 검색</button>
                        </div>

                        <div class="gi-input-container">
                            <label for="addr_dtl" class="gi-input-label"
                                data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_ADDR_DTL"]</label>
                            <input data-field="addr_dtl" id="addr_dtl" name="addr_dtl"
                                class="gi-input" autocomplete="off" />
                        </div>

                        <div class="gi-hidden">
                            <input data-field="post_cd" id="post_cd" name="post_cd" class="gi-input"
                                autocomplete="off" />
                        </div>
                    </div>

                    <div class="gi-margin-top-40px">
                        <h2 class="gi-title-section">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_ROLE"]</h2>
                        <div class="gi-flex gi-flex-column gi-grid-gap-20px">
                            <div class="gi-flex gi-grid-gap-20px">
                                <div class="gi-input-container" style="flex: 1;">
                                    <label for="offc_nm" class="gi-input-label"
                                        data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_OFFC_NM"]</label>
                                    <input data-field="offc_nm" id="offc_nm" name="offc_nm" class="gi-input"
                                        autocomplete="off" data-disabled />
                                </div>
                                <div class="gi-input-container" style="flex: 1;">
                                    <label for="offc_cd" class="gi-input-label"
                                        data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_OFFC_CD"]</label>
                                    <input data-field="offc_cd" id="offc_cd" name="offc_cd" class="gi-input"
                                        autocomplete="off" data-disabled />
                                </div>
                            </div>
                            <div class="gi-padding-10px">
                                <div id="user-group-div" class="gi-flex gi-flex-wrap gi-grid-gap-10px"></div>
                            </div>
                        </div>
                    </div>

                    <div class="gi-margin-top-40px">
                        <h2 class="gi-title-section">관리 정보</h2>
                        <div class="gi-flex gi-grid-gap-20px">
                            <div class="gi-input-container" style="flex: 1;">
                                <label for="sys_crt_dt" class="gi-input-label"
                                    data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_CREATE_DATE"]</label>
                                <input data-field="sys_crt_dt" id="sys_crt_dt" name="sys_crt_dt"
                                    class="gi-input" autocomplete="off" data-disabled />
                            </div>
                            <div class="gi-input-container" style="flex: 1;">
                                <label for="sys_upd_dt" class="gi-input-label"
                                    data-focus-label="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_LAST_UPDATE_DATE"]</label>
                                <input data-field="sys_upd_dt" id="sys_upd_dt" name="sys_upd_dt"
                                    class="gi-input" autocomplete="off" data-disabled />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 버튼 영역 -->
                <div class="gi-flex gi-flex-justify-content-center gi-grid-gap-16px gi-margin-top-40px">
                    <button id="change-password-btn" class="gi-btn gi-btn-modern-reset" type="button">비밀번호 변경</button>
                    <button id="modify-btn" class="gi-btn-blue gi-btn-modern-save"
                        type="button">[Page.Message].Message.Label.Array["SAVE_BTN"]</button>
                </div>
            </form>
        </div>
    </section>
</article>
<!--NOTE: 비밀번호 변경 팝업-->
<article id="change-password-popup" class="gi-popup" data-popup-open="false">
    <div class="gi-popup-body"
        style="width: 350px !important; height: auto !important; min-height: 300px; padding:10px;">
        <div class="gi-popup-header">
            <span>[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_PWD_CHANGE"]</span>
        </div>
        <div class="password-policy-section gi-row-90 gi-flex gi-flex-wrap" style="color:red; font-size:12px;"></div>
        <div class="gi-popup-contents">
            <!--      팝업내용 삽입 영역      -->
            <form id="sysUserPasswordChange" class="gi-row-100 gi-col-90">
                <div id="update-area_popup" class="gi-padding-left-right-20px">
                    <div class="gi-flex gi-flex-column gi-grid-gap-16px">
                        <div class="gi-input-container">
                            <label for="popup_before_pwd" class="gi-input-label" data-focus-label="true"
                                data-required="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_BEFORE_PWD"]</label>
                            <input type="password" data-field="popup_before_pwd" id="popup_before_pwd"
                                name="popup_before_pwd" class="gi-input" data-required="true" autocomplete="off" />
                        </div>
                        <div class="gi-input-container">
                            <label for="popup_new_pwd" class="gi-input-label" data-focus-label="true"
                                data-required="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_AFTER_PWD"]</label>
                            <input type="password" data-field="popup_new_pwd" id="popup_new_pwd"
                                name="popup_new_pwd" class="gi-input" data-required="true" autocomplete="off" />
                        </div>
                        <div class="gi-input-container">
                            <label for="popup_new_pwd_confirm" class="gi-input-label" data-focus-label="true"
                                data-required="true">[Page.Message].Message.Label.Array["SYS_USER.MYINFO.MY_AFTER_PWD_CONFIRM"]</label>
                            <input type="password" data-field="popup_new_pwd_confirm"
                                id="popup_new_pwd_confirm" name="popup_new_pwd_confirm" class="gi-input"
                                data-required="true" autocomplete="off" />
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!--/      팝업내용 삽입 영역      -->
        <div class="gi-popup-footer">
            <div
                class="gi-btn-section gi-row-30 gi-col-30px gi-padding-left-right-20px gi-flex gi-flex-justify-content-center gi-flex-align-items-center">
                <button type="button"
                    class="gi-btn-blue popup_success_btn">[Page.Message].Message.Label.Array["CONFIRM"]</button>
                <button class="gi-popup-close-btn" type="button">[Page.Message].Message.Label.Array["CANCEL"]</button>
            </div>
        </div>
    </div>
</article>
<script type="text/javascript">
    var PRGMID = "inspectionEquipmentModelTypeModify";	//page id

    init();


    function init() {
        new PageInit();
        //초기화
        resetEvent();
        dataSetting();
        setTimeout(function () {
            //클릭 이벤트
            clickEvent();
        });
    }

    async function dataSetting() {
        const userInfo = await findUserData();

        dataBinding.setDataForm(PRGMID, userInfo.user);

        bindUserGroup(userInfo.userGroups);
        // findImgFile();

        let data = dataBinding.getData(PRGMID);

        //초기 값 셋팅
        initValueSetting(data);

        function bindUserGroup(userGroups) {
            let userGroupHtml = '';
            userGroups.forEach((group) => {
                if (formUtil.checkEmptyValue(group.grp_nm)) {
                    userGroupHtml += "<span class='gi-tag-gray'>" + group.grp_nm + "</span>";
                }
            });

            $("#user-group-div").html(userGroupHtml);
        }
    }

    //NOTE: 유저 정보 조회
    async function findUserData() {
        try {
            const email = JwtUtils.getUserEmailFromJWT();

            const [userResponse, userGroupsResponse] = await Promise.all([
                axios.post('/cms/common/sysUser/find', { email }),
                axios.post('/cms/common/sysUserGroup/find', { user_email: email })
            ]);

            return {
                user: userResponse.data[0],
                userGroups: userGroupsResponse.data
            };
        } catch (error) {
            formUtil.alertPopup(error);
            throw error;
        }
    }

    function resetEvent() {
        //데이터 호출 후 이벤트 재설정
    }

    //클릭 이벤트
    function clickEvent() {
        //NOTE: 수정 버튼 클릭 이벤트
        $("#modify-btn").click(function () {
            formUtil.popup("modify_user_info-btn", Message.Label.Array["CONFIRM.SAVE"], modify);
        });

        $("#change-password-btn").click(async function () {
            let data = await findSiteConfigInPasswordPolicy();
            if (data) {
                setPasswordPolicyInPopupSection(data);
            }
            await changePasswordValidation();
        });
    }

    function initValueSetting(data) {
        // formUtil.createImgFileUpload("imgFileUpload", "/common/file/sysFileDetail", {FOLDER_NAME: "userImgFolder"}, modifyUserImage);
    }

    function modify() {
        if (checkValidation()) {
            let data = dataBinding.getData(PRGMID);
            let url = "/cms/common/sysUser/update";
            let param = {
                id: data.id,
                user_nm: data.user_nm,
                tel: data.tel,
                address: data.addr,
                addr_dtl: data.addr_dtl,
                post_cd: data.post_cd,
            };
            axios.post(url, param).then(response => {
                let status = response.status;
                if (status === 200) {
                    (new GiFormatCheck).resetToggleIcon();
                    formUtil.toast(Message.Label.Array["COMPLETE.UPDATE"]);
                } else {
                    formUtil.alertPopup("response status is :" + status);
                }
            }).catch(error => {
                formUtil.alertPopup(error);
            })
        }
    }
    // NOTE: 유효성 검사
    // NOTE: 유효성 검사
    function checkValidation() {
        return formUtil.validationCheck(PRGMID, "SYS_USER.CHECK.");
    }

    //NOTE : 비밀번호 변경 검사 로직
    async function changePasswordValidation() {
        $("#change-password-popup").attr("data-popup-open", "true");
        $(".popup_success_btn")
            .off("click.changePopupUpdateClickEventHandler")
            .on("click.changePopupUpdateClickEventHandler", changePopupUpdateClickEventHandler);

        function changePopupUpdateClickEventHandler() {
            let data = dataBinding.getData("sysUserPasswordChange");
            const beforePassword = data.popup_before_pwd;
            const newPassword = data.popup_new_pwd;
            const newPasswordConfirm = data.popup_new_pwd_confirm;

            if (!beforePassword || !newPassword || !newPasswordConfirm) {
                console.log(1)
                const message = Message.Label.Array["SYS_USER.CHECK.PWD"];
                formUtil.alertPopup(message);
                return false;
            }
            if (newPassword !== newPasswordConfirm) {
                console.log(2)
                const message = Message.Label.Array["SYS_USER.MYINFO.CHECK_PWD_DOUBLE_CHECK"]
                formUtil.alertPopup(message);
                return false;
            }
            if (beforePassword === newPassword) {
                console.log(3)
                const message = Message.Label.Array["FAIL.SAME.PWD"];
                formUtil.alertPopup(message);
                return false;
            }
            let cont = {
                beforePassword: beforePassword,
                newPassword: newPassword,
                newPasswordConfirm: newPasswordConfirm
            }
            changePassword(cont);
        }
    }
    //NOTE: 비밀번호 변경 API
    function changePassword(cont) {
        const url = "/cms/common/sysUser/changePassword";
        const param = {
            before_pwd: cont.beforePassword,
            password: cont.newPassword,
            email: JwtUtils.getUserEmailFromJWT()
        };
        axios.post(url, param).then(response => {
            console.log(response)
            if (response.status === 200) {
                formUtil.toast(Message.Label.Array["COMPLETE.UPDATE"]);
                popup.close("change-password-popup");
            }
        }).catch(error => {
            formUtil.alertPopup(error.response.data);
        })
    }
    //NOTE: 비밀번호변경 정책 조회
    function findSiteConfigInPasswordPolicy() {
        return new Promise((resolve, reject) => {
            let url = "/cms/common/sysSiteConfig/find";
            let param = {
                cfg_grp_id: "PWD_POLICY",
                use_yn: "1"
            }
            axios.post(url, param).then(response => {
                let status = response.status;
                if (status === 200) {
                    if (response.data.length > 0) {
                        let data = response.data;
                        resolve(data);
                    } else {
                        resolve(false);
                    }
                }
            }).catch(error => {
                formUtil.alertPopup(error.response.data);
            })
        })
    }
    //NOTE: 팝업안에 비밀번호 정책 공시
    function setPasswordPolicyInPopupSection(cont) {
        let contents = '';
        cont.map((item, i) => {
            contents += '<div class="gi-row-50"><span class="test">[' + (i + 1) + ']' + item.description + " : " + item.cfg_val + '</span></div>'
        })
        $(".password-policy-section").html(contents);
    }

    // function modifyUserImage() {
    //     let flag = checkValidation();
    //     if (flag) {
    //         let data = new dataBinding().getData(PRGMID);
    //         let url = "/common/common/sysUser/update";
    //         let param = {
    //             id: data.id,
    //             uuid: data.uuid,
    //         };
    //         axios.post(url, param).then(response => {
    //             let status = response.status;
    //             if (status === 200) {
    //                 formUtil.toast(Message.Label.Array["COMPLETE.UPDATE"]);
    //
    //                 findImgFile();
    //             } else {
    //                 formUtil.alertPopup("response status is :" + status);
    //             }
    //         }).catch(error => {
    //             formUtil.alertPopup(error);
    //         })
    //     }
    // }


    // function findImgFile() {
    //     let url = "/common/file/sysFileDetail/find";
    //     let param = {
    //         uuid: $('#uuid').val()
    //     }
    //     axios.post(url, param).then(response => {
    //         let status = response.status;
    //         if (status === 200) {
    //             if (formUtil.checkEmptyValue(response.data)) {
    //                 let data = response.data[0];
    //                 let filePath = data.file_path;
    //                 let fileId = data.file_id + "." + data.file_ext;
    //                 let cont = {
    //                     path: filePath,
    //                     file_id: fileId
    //                 }
    //                 findFileManagerGetImg(cont);
    //             }
    //         }
    //     }).catch(error => {
    //         formUtil.alertPopup(error + "");
    //     })
    // }

    // function findFileManagerGetImg(data) {
    //     let url = "/fileManager/searchImg";
    //     let param = {
    //         file_path: data.path + "/",
    //         file_id: data.file_id
    //     }
    //     axios.post(url, param).then(response => {
    //         let status = response.status;
    //         if (status === 200) {
    //             if (formUtil.checkEmptyValue(response.data)) {
    //                 let data = response.data;
    //                 $(".userIcon").css("background-image", "url('" + data + "')");
    //
    //                 setImageSource(data);
    //
    //                 $('#formUtil_fileUpload').empty(); // TODO
    //             }
    //         }
    //     }).catch(error => {
    //         formUtil.alertPopup(error + "");
    //     })
    // }

    // function setImageSource(url) {
    //     $('#user-image').attr('src', url);
    // }
</script>