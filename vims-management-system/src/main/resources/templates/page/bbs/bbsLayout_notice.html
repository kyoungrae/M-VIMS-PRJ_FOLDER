<article id="bbsLayoutNoticePage" class="gi-article-content gi-col-95 gi-row-100">
    <section class="gi-col-100 gi-row-100 gi-overflow-scroll">
        <header class="gi-margin-bottom-40px gi-padding-left-20px gi-padding-top-20px">
            <h1 id="notice-page-title" class="gi-page-title">[Page.Message].Message.Label.Array["NOTICE"]</h1>
            <p class="gi-subtitle-main">[Page.Message].Message.Label.Array["SYS_LAYOUT.IMPORTANT_NEWS"]</p>
        </header>
        <article>
            <!-- 공지사항은 상단 고정 등이 필요할 수 있음 -->
            <div id="search-area" class="gi-padding-left-right-20px gi-margin-bottom-30px">
                <div class="gi-flex gi-flex-align-items-center gi-grid-gap-20px">
                    <div class="gi-input-container gi-flex-1">
                        <label for="notice-search-input" class="gi-input-label"
                            data-focus-label="true">[Page.Message].Message.Label.Array["SYS_LAYOUT.NOTICE_SEARCH"]</label>
                        <input class="gi-input" type="text" id="notice-search-input" name="notice-search-input"
                            autocomplete="off" />
                    </div>
                    <div class="gi-flex gi-grid-gap-10px">
                        <button id="notice-search-btn"
                            class="gi-btn-blue">[Page.Message].Message.Label.Array["SEARCH_BTN"]</button>
                        <button id="bbsLayoutNoticePage-reset-btn" class="gi-btn"
                            type="button">[Page.Message].Message.Label.Array["RESET_BTN"]</button>
                    </div>

                </div>
            </div>
            <div class="gi-row-100 gi-padding-left-right-20px">
                <div id="bbs_notice_grid" class="gi-Grid gi-col-100"></div>
            </div>
            <!-- 등록버튼 영역 -->
            <div class="gi-row-100">
                <div class="gi-btn-section gi-row-30 gi-float-right gi-padding-left-right-20px">
                    <button id="bbs-notice-write-btn"
                        class="gi-btn-blue gi-float-right">[Page.Message].Message.Label.Array["SYS_LAYOUT.NOTICE_REGISTER"]</button>
                </div>
            </div>
        </article>
    </section>
</article>

<script type="text/javascript">
    var bbsSessionData = JSON.parse(sessionStorage.getItem("DATA"));
    var bbsId = bbsSessionData ? bbsSessionData.bbs_id : 'default_id';
    var bbsNm = bbsSessionData ? bbsSessionData.bbs_nm : Message.Label.Array["NOTICE"];
    var replyEnabled = false; // 댓글 기능 활성화 여부
    var isWritePermission = true; // 작성 권한 여부 (기본 true, 설정 있을 경우에만 체크)

    init();

    async function init() {
        new PageInit();

        // 페이지 타이틀 설정
        $("#notice-page-title").text(bbsNm);

        // BBS 설정 조회 (reply_yn 확인 및 권한 체크)
        await checkBbsConfiguration();

        findByNoticeList();
        clickEvent();
    }

    async function checkBbsConfiguration() {
        let url = "/cms/common/sysBbs/find";
        try {
            const response = await axios.post(url, { bbs_id: bbsId });
            if (response.status === 200 && response.data.length > 0) {
                let bbsInfo = response.data[0];
                if (bbsInfo.reply_yn === '1') {
                    replyEnabled = true;
                }

                // 권한 체크 로직 추가
                await checkWritePermission(bbsInfo.bbs_manager);
            }
        } catch (e) {
            console.error("BBS Config fetch failed", e);
        }
    }

    async function checkWritePermission(managers) {
        if (!managers || managers.trim() === "") {
            // 관리자가 지정되지 않은 경우 기본적으로 작성을 제한합니다.
            isWritePermission = false;
            $("#bbs-notice-write-btn").hide();
            return;
        }

        const writeBtn = $("#bbs-notice-write-btn");
        writeBtn.hide(); // 초기에는 숨김
        isWritePermission = false;

        let userInfo = new Session().getItem("userInfo");
        if (!userInfo || !userInfo.email) return;

        try {
            const url = "/cms/common/sysUserGroup/find";
            const response = await axios.post(url, { user_email: userInfo.email });
            const userGroups = response.data || [];
            const managerList = managers.split(",");

            isWritePermission = userGroups.some(ug => managerList.includes(ug.group_id));

            if (isWritePermission) {
                writeBtn.show();
            }
        } catch (e) {
            console.error("Permission check failed", e);
        }
    }

    function clickEvent() {
        $("#bbs-notice-write-btn").on("click", function () {
            if (!isWritePermission) {
                formUtil.toast(Message.Label.Array["FAIL.ACCESS_DENIED"] || "접근 권한이 없습니다.", "warning");
                return;
            }
            formUtil.apiLoadContent("cms", "/bbs/sysBbsBoardWrite", { bbs_id: bbsId });
        });

        $("#notice-search-btn").on("click", function () {
            findByNoticeList();
        });

        $("#bbsLayoutNoticePage-reset-btn").on("click", function () {
            $("#notice-search-input").val("");
            findByNoticeList();
        });

        $("#notice-search-input").on("keypress", function (e) {
            if (e.which == 13) {
                findByNoticeList();
            }
        });
    }

    function findByNoticeList(page, range) {
        if (!page) page = 1;
        if (!range) range = 10;

        let url = "/cms/common/sysBbsBoard/findPage";
        let param = {
            bbs_id: bbsId,
            page_no: page,
            row_range: range,
            offset: (page - 1) * range
        };

        let searchInput = $("#notice-search-input").val();
        if (searchInput) {
            param._title = searchInput;
        }

        axios.post(url, param).then(response => {
            if (response.status === 200) {
                let data = response.data.DATA;
                let paging = response.data.TOTAL_PAGING[0];

                let grid_header = {
                    title: bbsNm,
                    list: [
                        { HEADER: 'No', ID: 'no', WIDTH: '10', TYPE: 'text', TEXT_ALIGN: 'center' },
                        { HEADER: Message.Label.Array["SYS_LAYOUT.PRIORITY"], ID: 'priority', WIDTH: '10', FONT_SIZE: '12px', TYPE: 'text', TEXT_ALIGN: 'center', HIDDEN: true },
                        { HEADER: Message.Label.Array["SYS_LAYOUT.TITLE"], ID: 'title', WIDTH: replyEnabled ? '50' : '60', FONT_SIZE: '12px', TYPE: 'text', TEXT_ALIGN: 'left' },
                        { HEADER: Message.Label.Array["SYS_BBS_REPLY.REPLY_COUNT"], ID: 'reply_count', WIDTH: '10', FONT_SIZE: '12px', TYPE: 'text', TEXT_ALIGN: 'center', HIDDEN: !replyEnabled },
                        { HEADER: Message.Label.Array["SYS_LAYOUT.HIT_COUNT"], ID: 'hit_count', WIDTH: '10', FONT_SIZE: '12px', TYPE: 'text', TEXT_ALIGN: 'center' },
                        { HEADER: Message.Label.Array["SYS_LAYOUT.CREATE_DATE"], ID: 'system_create_date', WIDTH: '15', FONT_SIZE: '12px', TYPE: 'date', TEXT_ALIGN: 'center' }
                    ]
                };

                let grid = formUtil.giGrid(grid_header, paging, page, "bbs_notice_grid");
                grid.DataSet(data);
                grid.pagingSet(findByNoticeList);
                grid.rowClick(function (rowData) {
                    formUtil.apiLoadContent("cms", "/bbs/sysBbsBoardDetail", { board_id: rowData.board_id, bbs_id: bbsId });
                });
            }
        });
    }
</script>