<article id="bbsLayoutGalleryPage" class="gi-article-content gi-col-95 gi-row-100">
    <style>
        /* Gallery Specific Styles */
        .gi-gallery-header {
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .gi-gallery-total {
            font-size: 16px;
            color: #64748b;
        }

        .gi-gallery-total b {
            color: var(--background-color-btn-blue);
            font-size: 18px;
        }

        .gi-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            padding: 0 20px 40px 20px;
        }

        .gi-gallery-card {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            border: 1px solid #f1f5f9;
        }

        .gi-gallery-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .gi-gallery-img-wrapper {
            position: relative;
            width: 100%;
            padding-top: 66.66%;
            /* 3:2 Ratio */
            overflow: hidden;
            background-color: #f8fafc;
        }

        .gi-gallery-img-wrapper img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        /* noImage state */
        .gi-gallery-img-wrapper img.no-image {
            width: 50%;
            height: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            object-fit: contain;
        }

        .gi-gallery-card:hover .gi-gallery-img-wrapper img:not(.no-image) {
            transform: scale(1.05);
        }

        .gi-gallery-card:hover .gi-gallery-img-wrapper img.no-image {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .gi-gallery-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .gi-gallery-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-all;
        }

        .gi-gallery-desc {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .gi-gallery-footer {
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
            font-size: 12px;
            color: #94a3b8;
        }

        .gi-gallery-footer span {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .gi-gallery-footer span:first-child {
            flex: 1;
        }

        .gi-gallery-footer i {
            font-size: 12px;
            color: var(--background-color-btn-blue);
            opacity: 0.7;
            flex-shrink: 0;
        }

        .gi-gallery-actions {
            padding: 0 20px 20px 20px;
            display: flex;
            justify-content: flex-end;
        }

        .gi-paging-container {
            display: flex;
            justify-content: center;
            padding: 20px 0;
            gap: 8px;
        }

        .gi-paging-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gi-paging-btn:hover {
            border-color: var(--background-color-btn-blue);
            color: var(--background-color-btn-blue);
        }

        .gi-paging-btn.active {
            background-color: var(--background-color-btn-blue);
            color: #fff;
            border-color: var(--background-color-btn-blue);
        }

        .gi-gallery-row-selector {
            width: 100px;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            color: #64748b;
            outline: none;
            background-color: #fff;
            cursor: pointer;
        }

        .gi-gallery-row-selector:focus {
            border-color: var(--background-color-btn-blue);
        }
    </style>

    <section class="gi-col-100 gi-row-100 gi-overflow-scroll">
        <header class="gi-margin-bottom-40px gi-padding-left-20px gi-padding-top-20px">
            <h1 id="gallery-page-title" class="gi-page-title">[Page.Message].Message.Label.Array["GALLERY"]</h1>
            <p class="gi-subtitle-main">[Page.Message].Message.Label.Array["SYS_LAYOUT.IMAGE_GALLERY_LIST"]</p>
        </header>

        <article>
            <!-- 검색기능 영역 (표준 UI) -->
            <div id="search-area" class="gi-padding-left-right-20px gi-margin-bottom-30px">
                <div class="gi-flex gi-flex-align-items-center gi-grid-gap-20px">
                    <div class="gi-input-container gi-flex-1">
                        <label for="gallery-search-input" class="gi-input-label"
                            data-focus-label="true">[Page.Message].Message.Label.Array["SEARCH_KEYWORD"]</label>
                        <input class="gi-input" type="text" id="gallery-search-input" name="gallery-search-input"
                            autocomplete="off" />
                    </div>
                    <div class="gi-flex gi-grid-gap-10px">
                        <button id="gallery-search-btn" class="gi-btn-blue"
                            type="button">[Page.Message].Message.Label.Array["SEARCH_BTN"]</button>
                        <button id="gallery-reset-btn" class="gi-btn"
                            type="button">[Page.Message].Message.Label.Array["RESET_BTN"]</button>
                    </div>
                </div>
            </div>

            <div class="gi-gallery-header gi-flex gi-flex-justify-content-space-between gi-flex-align-items-center">
                <div class="gi-gallery-total">
                    [Page.Message].Message.Label.Array["TOTAL"] <b id="gallery-total-count">0</b>
                </div>
                <select id="gallery-row-selector" class="gi-gallery-row-selector">
                    <option value="12">12 [Page.Message].Message.Label.Array["ROW"]</option>
                    <option value="24">24 [Page.Message].Message.Label.Array["ROW"]</option>
                    <option value="36">36 [Page.Message].Message.Label.Array["ROW"]</option>
                    <option value="48">48 [Page.Message].Message.Label.Array["ROW"]</option>
                    <option value="60">60 [Page.Message].Message.Label.Array["ROW"]</option>
                </select>
            </div>

            <div id="gallery-card-container" class="gi-gallery-grid">
                <!-- Cards will be rendered here -->
            </div>

            <div id="gallery-pagination" class="gi-paging-container">
                <!-- Pagination will be rendered here -->
            </div>

            <div class="gi-gallery-actions">
                <button id="bbs-gallery-write-btn" class="gi-btn-blue">
                    <i class="fa-solid fa-pencil gi-margin-right-8px"></i>
                    [Page.Message].Message.Label.Array["WRITE_BTN"]
                </button>
            </div>
        </article>
    </section>
</article>

<script type="text/javascript">
    var bbsSessionData = JSON.parse(sessionStorage.getItem("DATA"));
    var bbsId = bbsSessionData ? bbsSessionData.bbs_id : 'default_id';
    var bbsNm = bbsSessionData ? bbsSessionData.bbs_nm : Message.Label.Array["GALLERY"];

    init();

    function init() {
        new PageInit();

        // 페이지 타이틀 설정
        $("#gallery-page-title").text(bbsNm);

        // 초기 목록 조회
        const initialRange = $("#gallery-row-selector").val() || 12;
        findByGalleryList(1, initialRange);
        clickEvent();
    }

    function clickEvent() {
        $("#bbs-gallery-write-btn").on("click", function () {
            formUtil.apiLoadContent("cms", "/bbs/sysBbsBoardWrite", { bbs_id: bbsId });
        });

        $("#gallery-search-btn").on("click", function () {
            findByGalleryList(1);
        });

        $("#gallery-reset-btn").on("click", function () {
            $("#gallery-search-input").val("");
            findByGalleryList(1);
        });

        $("#gallery-search-input").on("keypress", function (e) {
            if (e.which == 13) {
                const range = $("#gallery-row-selector").val();
                findByGalleryList(1, range);
            }
        });

        $("#gallery-row-selector").on("change", function () {
            const range = $(this).val();
            findByGalleryList(1, range);
        });
    }

    async function findByGalleryList(page, range) {
        if (!page) page = 1;
        if (!range) range = $("#gallery-row-selector").val() || 12;

        let url = "/cms/common/sysBbsBoard/findPage";
        let param = {
            bbs_id: bbsId,
            page_no: page,
            row_range: range,
            offset: (page - 1) * range
        };

        let searchInput = $("#gallery-search-input").val();
        if (searchInput) {
            param._title = searchInput;
        }

        try {
            const response = await axios.post(url, param);
            if (response.status === 200) {
                let data = response.data.DATA;
                let totalCount = response.data.TOTAL_COUNT ? response.data.TOTAL_COUNT[0] : 0;
                let totalPages = response.data.TOTAL_PAGING ? response.data.TOTAL_PAGING[0] : 0;

                $("#gallery-total-count").text(totalCount);
                renderCards(data);
                renderPagination(totalPages, page, range);

                commonTag.inputTagReset($(".gi-input"));
            }
        } catch (error) {
            console.error("Failed to fetch gallery list", error);
        }
    }

    function renderCards(data) {
        const container = $("#gallery-card-container");
        container.empty();

        if (!data || data.length === 0) {
            container.html('<div class="gi-text-align-center gi-padding-40px" style="color: #94a3b8; grid-column: 1 / -1;">' + Message.Label.Array["FAIL.SELECT_NO_DATA"] + '</div>');
            return;
        }

        data.forEach(item => {
            // thumbnail 컬럼이 있으면 우선 사용, 없으면 기본 이미지
            let hasThumbnail = !!item.thumbnail;
            let imgSrc = hasThumbnail ? '/fms/fileManager/downloadByUuid?fileUuid=' + item.thumbnail : '/common/img/noImage.png';
            let imgClass = hasThumbnail ? '' : 'no-image';

            const card = $(`
                <div class="gi-gallery-card">
                    <div class="gi-gallery-img-wrapper">
                        <img src="${imgSrc}" class="${imgClass}" onerror="this.src='/common/img/noImage.png'; this.className='no-image';" alt="${item.title}">
                    </div>
                    <div class="gi-gallery-content">
                        <div class="gi-gallery-title">${item.title || Message.Label.Array["NO_TITLE"]}</div>
                        <div class="gi-gallery-desc">${stripHtml(item.content || '').substring(0, 150)}...</div>
                        <div class="gi-gallery-footer">
                            <span><i class="fa-solid fa-user"></i> ${item.writer_name || Message.Label.Array["UNKNOWN"]}</span>
                            <span><i class="fa-solid fa-calendar"></i> ${formatDate(item.system_create_date)}</span>
                            <span><i class="fa-solid fa-eye"></i> ${item.hit_count || 0}</span>
                            <span><i class="fa-solid fa-comment"></i> ${item.reply_count || 0}</span>
                        </div>
                    </div>
                </div>
            `);

            card.on("click", function () {
                formUtil.apiLoadContent("cms", "/bbs/sysBbsBoardDetail", { board_id: item.board_id, bbs_id: bbsId });
            });

            container.append(card);
        });
    }

    function renderPagination(totalPages, currentPage, range) {
        const container = $("#gallery-pagination");
        container.empty();

        if (totalPages <= 1) return;

        const maxVisible = 5;
        let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(totalPages, start + maxVisible - 1);

        if (end - start + 1 < maxVisible) {
            start = Math.max(1, end - maxVisible + 1);
        }

        // 이전 버튼
        if (currentPage > 1) {
            container.append($('<button class="gi-paging-btn"><i class="fa-solid fa-chevron-left"></i></button>').on("click", () => findByGalleryList(currentPage - 1)));
        }

        for (let i = start; i <= end; i++) {
            const btn = $(`<button class="gi-paging-btn ${i === currentPage ? 'active' : ''}">${i}</button>`);
            btn.on("click", () => findByGalleryList(i));
            container.append(btn);
        }

        // 다음 버튼
        if (currentPage < totalPages) {
            container.append($('<button class="gi-paging-btn"><i class="fa-solid fa-chevron-right"></i></button>').on("click", () => findByGalleryList(currentPage + 1)));
        }
    }

    function stripHtml(html) {
        let tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return dateStr.substring(0, 10);
    }
</script>