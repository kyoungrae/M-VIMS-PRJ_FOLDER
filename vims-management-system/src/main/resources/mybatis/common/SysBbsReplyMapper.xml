<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vims.common.bbs.SysBbsReplyMapper">
    <sql id="sortFilter">
        ORDER BY
        <choose>
            <when test="sort_id != null and sort_order != null">
                ${sort_id} ${sort_order}
            </when>
            <otherwise>
                sys_crt_dt ASC
            </otherwise>
        </choose>
    </sql>

    <select id="SELECT_PAGE" resultType="com.vims.common.bbs.SysBbsReply">
        SELECT * FROM (
            SELECT
                row_number() over (ORDER BY sys_crt_dt ASC) AS no,
                reply_id,
                board_id,
                parent_reply_id,
                content,
                wrtr_nm,
                sys_crt_usr_id,
                sys_crt_dt,
                sys_upd_usr_id,
                sys_upd_dt
            FROM SYS_BBS_RPLY
            <where>
                <if test="reply_id != null and reply_id != ''">AND reply_id = #{reply_id}</if>
                <if test="board_id != null and board_id != ''">AND board_id = #{board_id}</if>
                <if test="parent_reply_id != null and parent_reply_id != ''">AND parent_reply_id = #{parent_reply_id}</if>
                <if test="_content != null and _content != ''">AND content LIKE CONCAT('%', #{_content}, '%')</if>
                <if test="_wrtr_nm != null and _wrtr_nm != ''">AND wrtr_nm LIKE CONCAT('%', #{_wrtr_nm}, '%')</if>
            </where>
        ) AS sub
        <include refid="sortFilter"/>
        <if test="row_range != null and offset != null">
            LIMIT #{row_range} OFFSET #{offset}
        </if>
    </select>

    <select id="SELECT_PAGING_TOTAL_NUMBER" resultType="int">
        SELECT CEIL(COUNT(*) / #{row_range}) FROM SYS_BBS_RPLY
        <where>
            <if test="board_id != null and board_id != ''">AND board_id = #{board_id}</if>
            <if test="_content != null and _content != ''">AND content LIKE CONCAT('%', #{_content}, '%')</if>
        </where>
    </select>

    <select id="SELECT" resultType="com.vims.common.bbs.SysBbsReply">
        SELECT
            reply_id, board_id, parent_reply_id, content, wrtr_nm,
            sys_crt_usr_id, sys_crt_dt, sys_upd_usr_id, sys_upd_dt
        FROM SYS_BBS_RPLY
        <where>
            <if test="reply_id != null and reply_id != ''">AND reply_id = #{reply_id}</if>
            <if test="board_id != null and board_id != ''">AND board_id = #{board_id}</if>
        </where>
    </select>

    <!-- 게시물 ID로 댓글 목록 조회 (계층 구조 정렬: 부모 댓글 먼저, 그 아래 대댓글) -->
    <select id="SELECT_BY_BOARD_ID" resultType="com.vims.common.bbs.SysBbsReply">
        SELECT
            reply_id, board_id, parent_reply_id, content, wrtr_nm,
            sys_crt_usr_id, sys_crt_dt, sys_upd_usr_id, sys_upd_dt
        FROM SYS_BBS_RPLY
        WHERE board_id = #{board_id}
        ORDER BY 
            COALESCE(parent_reply_id, reply_id) ASC,
            parent_reply_id IS NOT NULL ASC,
            sys_crt_dt ASC
    </select>

    <!-- 게시물별 댓글 수 조회 -->
    <select id="COUNT_BY_BOARD_ID" resultType="int">
        SELECT COUNT(*) FROM SYS_BBS_RPLY WHERE board_id = #{board_id}
    </select>

    <insert id="INSERT">
        INSERT INTO SYS_BBS_RPLY(
            reply_id, board_id, parent_reply_id, content, wrtr_nm,
            sys_crt_usr_id, sys_crt_dt, sys_upd_usr_id, sys_upd_dt
        )
        VALUES(
            #{reply_id}, #{board_id}, #{parent_reply_id}, #{content}, #{wrtr_nm},
            #{sys_crt_usr_id}, NOW(), #{sys_upd_usr_id}, NOW()
        )
    </insert>

    <update id="UPDATE">
        UPDATE SYS_BBS_RPLY
        <set>
            <if test="content != null">content = #{content},</if>
            <if test="wrtr_nm != null">wrtr_nm = #{wrtr_nm},</if>
            sys_upd_usr_id = #{sys_upd_usr_id},
            sys_upd_dt = NOW()
        </set>
        <where>
            AND reply_id = #{reply_id}
        </where>
    </update>

    <delete id="DELETE">
        DELETE FROM SYS_BBS_RPLY 
        WHERE reply_id = #{reply_id} OR parent_reply_id = #{reply_id}
    </delete>
</mapper>
